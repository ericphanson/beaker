# Test Makefile for beaker Make compatibility with alternative model
# Tests that changing model parameters causes rebuilds

# Test images and outputs
TEST_IMG := example.jpg
DETECT_DEFAULT := test_crop_default.jpg
DETECT_ALT_CONF := test_crop_alt_conf.jpg

# Beaker binary
BEAKER := ../../../target/release/beaker

# Test targets
.PHONY: all test_model_changes clean

all: $(DETECT_DEFAULT) $(DETECT_ALT_CONF)

# Detection with default configuration
$(DETECT_DEFAULT): $(TEST_IMG)
	@echo "Building detection with default confidence from $<"
	$(BEAKER) detect $< --confidence 0.25 --crop bird --metadata --depfile $@.d

# Detection with alternative confidence (should cause different stamp)
$(DETECT_ALT_CONF): $(TEST_IMG)
	@echo "Building detection with alternative confidence from $<"
	$(BEAKER) detect $< --confidence 0.7 --crop bird --metadata --depfile $@.d

# Include dependency files if they exist
-include $(DETECT_DEFAULT).d
-include $(DETECT_ALT_CONF).d

# Test that model parameter changes trigger rebuilds
test_model_changes: clean
	@echo "=== Testing model parameter change handling ==="
	@echo "1. Build with default confidence"
	$(MAKE) -f Makefile.alt_model $(DETECT_DEFAULT)
	@echo "2. Build with alternative confidence"
	$(MAKE) -f Makefile.alt_model $(DETECT_ALT_CONF)
	@echo "3. Rebuild default (should do nothing)"
	$(MAKE) -f Makefile.alt_model $(DETECT_DEFAULT)
	@echo "4. Rebuild alternative (should do nothing)"
	$(MAKE) -f Makefile.alt_model $(DETECT_ALT_CONF)
	@echo "=== Model parameter test complete ==="

clean:
	rm -f $(DETECT_DEFAULT) $(DETECT_ALT_CONF)
	rm -f $(DETECT_DEFAULT).d $(DETECT_ALT_CONF).d
	rm -f *.beaker.toml *.beaker.json
