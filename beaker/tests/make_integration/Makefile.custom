BEAKER := ../../../target/release/beaker
# Makefile for testing beaker incremental build compatibility
# This verifies that beaker integrates properly with Make for dependency tracking

# Test images and outputs
TEST_IMG := test.jpg
CUTOUT_OUTPUT := test_cutout.png
DETECT_OUTPUT := test_crop.jpg

# Beaker binary (use cargo run in development)
BEAKER := cargo run --release --

# Test targets
.PHONY: all test_incremental clean

all: $(CUTOUT_OUTPUT) $(DETECT_OUTPUT)

# Cutout target - includes depfile generation
$(CUTOUT_OUTPUT): $(TEST_IMG)
	@echo "Building cutout from $<"
	$(BEAKER) cutout $< --metadata --depfile $@.d

# Detection target - includes depfile generation
$(DETECT_OUTPUT): $(TEST_IMG)
	@echo "Building detection crops from $<"
	$(BEAKER) detect $< --confidence 0.5 --crop bird --metadata --depfile $@.d

# Include dependency files if they exist
-include $(CUTOUT_OUTPUT).d
-include $(DETECT_OUTPUT).d

# Test incremental behavior
test_incremental: clean
	@echo "=== Testing incremental builds ==="
	@echo "1. Initial build (should build both targets)"
	$(MAKE) all
	@echo "2. Immediate rebuild (should do nothing)"
	$(MAKE) all
	@echo "3. Touch input (should rebuild both)"
	touch $(TEST_IMG)
	$(MAKE) all
	@echo "=== Incremental build test complete ==="

clean:
	rm -f $(CUTOUT_OUTPUT) $(DETECT_OUTPUT)
	rm -f $(CUTOUT_OUTPUT).d $(DETECT_OUTPUT).d
	rm -f *.beaker.toml *.beaker.json
